<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AVODA Wallet</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@4.1.2/dist/web3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body {
      background: #000;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      text-align: center;
    }
    .container {
      max-width: 400px;
      margin: auto;
      padding: 30px;
      background: #111;
      border-radius: 20px;
      box-shadow: 0 0 15px rgba(255,255,255,0.1);
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 10px;
      border: none;
      font-size: 1rem;
    }
    button {
      background: #fff;
      color: #000;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background: #ccc;
    }
    .qr {
      margin: 20px auto;
    }
    .copy-btn {
      margin-top: 5px;
      background: #444;
      color: #fff;
    }
    .screen { display: none; }
  </style>
</head>
<body>
  <div id="unlockScreen" class="container screen" style="display: block;">
    <h2>üîê Unlock Wallet</h2>
    <input type="password" id="pinInput" placeholder="Enter 4-digit PIN"/>
    <button id="unlockBtn">Unlock</button>
  </div>

  <div id="walletScreen" class="container screen">
    <h2>üöÄ AVODA Wallet</h2>
    <select id="networkSelect">
      <option value="https://ethereum-sepolia.publicnode.com">Ethereum Sepolia</option>
      <option value="https://polygon-mumbai.publicnode.com">Polygon Mumbai</option>
      <option value="https://bsc-testnet.publicnode.com">BNB Testnet</option>
    </select>

    <div id="addressBox"></div>
    <button class="copy-btn" onclick="copyToClipboard(address)">üìã Copy Address</button>
    <div class="qr" id="qrCode"></div>

    <div id="privateKeyBox"></div>
    <button class="copy-btn" onclick="copyToClipboard(privateKey)">üìã Copy Private Key</button>

    <p id="balanceBox">Balance: ...</p>

    <h3>üì§ Send ETH</h3>
    <input type="text" id="toAddress" placeholder="To Address"/>
    <input type="text" id="amount" placeholder="Amount in ETH"/>
    <button id="sendTxBtn">Send</button>

    <h3>üìú History</h3>
    <div id="historyBox">No history yet.</div>
  </div>

  <div id="setupScreen" class="container screen">
    <h2>üõ†Ô∏è Setup Wallet</h2>
    <input type="password" id="newPin" placeholder="Set 4-digit PIN"/>
    <button id="createWalletBtn">‚ûï Create Wallet</button>
    <button id="importWalletBtn">üì• Import Wallet</button>
  </div>

<script>
  let web3, account;
  let privateKey = "";
  let address = "";

  function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
    document.getElementById(id).style.display = 'block';
  }

  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => alert("Copied!"));
  }

  function encrypt(text, pin) {
    return CryptoJS.AES.encrypt(text, pin).toString();
  }

  function decrypt(cipher, pin) {
    try {
      return CryptoJS.AES.decrypt(cipher, pin).toString(CryptoJS.enc.Utf8);
    } catch {
      return null;
    }
  }

  function saveEncryptedWallet(pk, pin) {
    localStorage.setItem("wallet", encrypt(pk, pin));
  }

  function getSavedPin() {
    return localStorage.getItem("pin");
  }

  function savePin(pin) {
    localStorage.setItem("pin", pin);
  }

  async function initWeb3(rpc) {
    web3 = new Web3(rpc);
  }

  async function createNewWallet(pin) {
    account = web3.eth.accounts.create();
    privateKey = account.privateKey;
    address = account.address;
    saveEncryptedWallet(privateKey, pin);
    showAccountInfo();
    showScreen("walletScreen");
  }

  async function importWalletByPK(pin) {
    const pk = prompt("Paste your Private Key:");
    if (!pk || !pk.startsWith("0x")) return alert("Invalid private key.");
    account = web3.eth.accounts.privateKeyToAccount(pk);
    privateKey = pk;
    address = account.address;
    saveEncryptedWallet(pk, pin);
    showAccountInfo();
    showScreen("walletScreen");
  }

  async function showAccountInfo() {
    address = account.address;
    privateKey = account.privateKey;

    document.getElementById("addressBox").innerText = "Address: " + address;
    document.getElementById("privateKeyBox").innerText = "Private Key: " + privateKey;

    QRCode.toCanvas(document.getElementById("qrCode"), address);

    const bal = await web3.eth.getBalance(address);
    document.getElementById("balanceBox").innerText = "Balance: " + web3.utils.fromWei(bal) + " ETH";
  }

  async function sendTransaction() {
    const to = document.getElementById("toAddress").value;
    const amt = document.getElementById("amount").value;
    const tx = {
      to,
      value: web3.utils.toWei(amt),
      gas: 21000,
      maxFeePerGas: web3.utils.toWei('8', 'gwei'),
      maxPriorityFeePerGas: web3.utils.toWei('2', 'gwei')
    };

    const signed = await web3.eth.accounts.signTransaction(tx, privateKey);
    const res = await web3.eth.sendSignedTransaction(signed.rawTransaction);
    document.getElementById("historyBox").innerHTML += `<p>‚úÖ Tx: <a href="#" target="_blank">${res.transactionHash}</a></p>`;
    await showAccountInfo();
  }

  document.getElementById("unlockBtn").addEventListener("click", () => {
    const pin = document.getElementById("pinInput").value;
    const cipher = localStorage.getItem("wallet");
    if (!cipher) return showScreen("setupScreen");

    const pk = decrypt(cipher, pin);
    if (pk && pk.startsWith("0x")) {
      savePin(pin);
      account = web3.eth.accounts.privateKeyToAccount(pk);
      privateKey = pk;
      address = account.address;
      showAccountInfo();
      showScreen("walletScreen");
    } else {
      alert("Wrong PIN!");
    }
  });

  document.getElementById("createWalletBtn").addEventListener("click", async () => {
    const pin = document.getElementById("newPin").value;
    if (pin.length !== 4) return alert("PIN must be 4 digits.");
    savePin(pin);
    await createNewWallet(pin);
  });

  document.getElementById("importWalletBtn").addEventListener("click", async () => {
    const pin = document.getElementById("newPin").value;
    if (pin.length !== 4) return alert("PIN must be 4 digits.");
    savePin(pin);
    await importWalletByPK(pin);
  });

  document.getElementById("sendTxBtn").addEventListener("click", sendTransaction);

  document.getElementById("networkSelect").addEventListener("change", async () => {
    if (!account) return;
    await initWeb3(document.getElementById("networkSelect").value);
    showAccountInfo();
  });

  window.addEventListener("load", () => {
    initWeb3(document.getElementById("networkSelect").value);
  });
</script>
</body>
      </html>
