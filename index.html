<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Avoda Wallet ðŸŒ¿</title>
<!-- Web3.js -->
<script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>
<!-- CryptoJS for encryption -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<!-- QRCode.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
<style>
  body {
    margin: 0; font-family: 'Inter', sans-serif; background: #0f172a; color: white;
    display: flex; justify-content: center; align-items: center; min-height: 100vh;
    padding: 20px;
  }
  .container {
    background: #1e293b; border-radius: 16px; padding: 30px;
    width: 100%; max-width: 420px;
    box-shadow: 0 0 20px rgba(74, 222, 128, 0.5);
  }
  h1 {
    text-align: center; color: #4ade80; margin-bottom: 20px;
    user-select: none;
  }
  select, input, button {
    width: 100%; padding: 12px 15px; margin: 10px 0;
    border-radius: 12px; border: none; font-size: 16px;
    box-sizing: border-box;
  }
  select, input {
    background: #334155; color: white;
  }
  input::placeholder {
    color: #94a3b8;
  }
  button {
    background: #4ade80; color: #0f172a; font-weight: 600;
    cursor: pointer; transition: background 0.3s ease;
  }
  button:hover {
    background: #22c55e;
  }
  .balance, .history {
    background: #0f172a; padding: 15px; border-radius: 12px;
    margin-top: 15px;
  }
  .balance strong, .history strong {
    color: #a3e635;
  }
  #historyList {
    list-style-type: none; padding-left: 0; margin-top: 8px; max-height: 120px; overflow-y: auto;
  }
  #historyList li {
    margin-bottom: 6px; font-size: 14px; color: #cbd5e1;
  }
  #qrcode {
    margin: 20px auto;
    width: 140px; height: 140px;
    background: white; border-radius: 12px;
  }
  .btn-row {
    display: flex; gap: 10px;
  }
  .btn-row button {
    flex: 1;
  }
  label {
    display: block; margin-top: 10px; font-weight: 600; color: #a3e635;
    user-select: none;
  }
  @media (max-width: 480px) {
    .container { padding: 20px; }
  }
</style>
</head>
<body>

<div class="container">
  <h1>Avoda Wallet ðŸŒ¿</h1>

  <label for="network">Select Network</label>
  <select id="network">
    <option value="https://mainnet.infura.io/v3/YOUR_INFURA_ID">Ethereum Mainnet</option>
    <option value="https://polygon-rpc.com">Polygon</option>
    <option value="https://bsc-dataseed.binance.org/">Binance Smart Chain</option>
  </select>

  <div class="btn-row">
    <button id="connectBtn">ðŸ”Œ Connect MetaMask</button>
    <button id="createBtn">ðŸ†• Create Wallet</button>
  </div>

  <input id="privateKeyInput" placeholder="Enter Private Key to Import" autocomplete="off" />
  <button id="importBtn">ðŸ“¥ Import Wallet</button>

  <label for="passwordInput">Password (for local encryption)</label>
  <input id="passwordInput" type="password" placeholder="Set/Enter password" autocomplete="off" />

  <div class="balance">
    <strong>Balance:</strong> <span id="balance">--</span> ETH
  </div>

  <label for="toAddress">Send To Address</label>
  <input id="toAddress" placeholder="Receiver Address" autocomplete="off" />
  <label for="amount">Amount (ETH)</label>
  <input id="amount" type="number" step="0.0001" placeholder="Amount to Send" />

  <button id="sendBtn">ðŸ“¤ Send Transaction</button>

  <button id="copyBtn">ðŸ“‹ Copy Private Key</button>

  <div id="qrcode"></div>

  <div class="history">
    <strong>Transaction History (local):</strong>
    <ul id="historyList"></ul>
  </div>
</div>

<script>
  let web3;
  let account;
  let historyList = [];
  const encryptedPKKey = "avoda_wallet_encrypted_pk";

  function initWeb3(providerUrl) {
    if (window.ethereum && providerUrl.includes("infura.io")) {
      // Use injected MetaMask provider for Ethereum Mainnet (Infura URL fallback)
      web3 = new Web3(window.ethereum);
    } else {
      web3 = new Web3(new Web3.providers.HttpProvider(providerUrl));
    }
  }

  function displayWalletInfo() {
    if (!account) return;
    generateQRCode(account.address);
    fetchBalance();
  }

  function createWallet() {
    if (!web3) web3 = new Web3();
    account = web3.eth.accounts.create();
    alert(`New Wallet Created!\n\nAddress: ${account.address}\nPrivate Key:\n${account.privateKey}\n\nSave your private key safely!`);
    displayWalletInfo();
    saveWalletEncrypted();
  }

  function importWallet() {
    const key = document.getElementById("privateKeyInput").value.trim();
    if (!key) return alert("Please enter a private key");
    try {
      account = web3.eth.accounts.privateKeyToAccount(key);
      displayWalletInfo();
      saveWalletEncrypted();
      alert("Wallet imported successfully!");
    } catch (e) {
      alert("Invalid private key.");
    }
  }

  function saveWalletEncrypted() {
    const pw = document.getElementById("passwordInput").value;
    if (!pw || !account || !account.privateKey) return; // don't save without password or account
    try {
      const encrypted = CryptoJS.AES.encrypt(account.privateKey, pw).toString();
      localStorage.setItem(encryptedPKKey, encrypted);
    } catch (e) {
      console.error("Encryption error:", e);
    }
  }

  function loadWalletEncrypted() {
    const pw = document.getElementById("passwordInput").value;
    if (!pw) return;
    const encrypted = localStorage.getItem(encryptedPKKey);
    if (!encrypted) return;
    try {
      const bytes = CryptoJS.AES.decrypt(encrypted, pw);
      const decryptedPK = bytes.toString(CryptoJS.enc.Utf8);
      if (!decryptedPK) return alert("Wrong password or no saved wallet found");
      account = web3.eth.accounts.privateKeyToAccount(decryptedPK);
      displayWalletInfo();
      alert("Wallet loaded from local storage!");
    } catch (e) {
      alert("Failed to decrypt wallet");
    }
  }

  function fetchBalance() {
    if (!account || !account.address) {
      document.getElementById("balance").innerText = "--";
      return;
    }
    web3.eth.getBalance(account.address).then(balance => {
      document.getElementById("balance").innerText = web3.utils.fromWei(balance, "ether");
    }).catch(() => {
      document.getElementById("balance").innerText = "Error";
    });
  }

  function sendTransaction() {
    if (!account) return alert("Connect or import wallet first");
    const to = document.getElementById("toAddress").value.trim();
    const amount = document.getElementById("amount").value.trim();
    if (!to || !amount) return alert("Enter receiver address and amount");
    if (!web3.utils.isAddress(to)) return alert("Invalid receiver address");
    const valueWei = web3.utils.toWei(amount, "ether");

    if (window.ethereum) {
      const txParams = {
        from: account.address,
        to: to,
        value: valueWei,
        gas: '21000'
      };
      window.ethereum.request({
        method: "eth_sendTransaction",
        params: [txParams]
      }).then(() => {
        alert("Transaction sent!");
        historyList.push(`To: ${to}, Amount: ${amount} ETH`);
        updateHistory();
        fetchBalance();
      }).catch(err => {
        alert("Transaction failed: " + err.message);
      });
    } else {
      alert("MetaMask not connected");
    }
  }

  function copyPrivateKey() {
    if (!account || !account.privateKey) return alert("No private key to copy");
    navigator.clipboard.writeText(account.privateKey).then(() => {
      alert("Private key copied to clipboard!");
    }).catch(() => {
      alert("Failed to copy private key.");
    });
  }

  function generateQRCode(text) {
    const qrContainer = document.getElementById("qrcode");
    qrContainer.innerHTML = "";
    if (!text) return;
    new QRCode(qrContainer, {
      text: text,
      width: 140,
      height: 140,
      colorDark: "#0f172a",
      colorLight: "#4ade80",
      correctLevel: QRCode.CorrectLevel.H
    });
  }

  function updateHistory() {
    const list = document.getElementById("historyList");
    list.innerHTML = "";
    historyList.slice(-5).reverse().forEach(tx => {
      const li = document.createElement("li");
      li.textContent = tx;
      list.appendChild(li);
    });
  }

  // Event listeners
  document.getElementById("connectBtn").addEventListener("click", async () => {
    if (window.ethereum) {
      web3 = new Web3(window.ethereum);
      try {
        const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
        account = web3.eth.accounts.wallet.add(accounts[0]) || { address: accounts[0] };
        displayWalletInfo();
        alert("MetaMask wallet connected!");
      } catch {
        alert("User denied wallet connection");
      }
    } else {
      alert("MetaMask is not installed");
    }
  });

  document.getElementById("createBtn").addEventListener("click", () => {
    if (!web3) web3 = new Web3();
    createWallet();
  });

  document.getElementById("importBtn").addEventListener("click", () => {
    importWallet();
  });

  document.getElementById("copyBtn").addEventListener("click", () => {
    copyPrivateKey();
  });

  document.getElementById("sendBtn").addEventListener("click", () => {
    sendTransaction();
  });

  document.getElementById("passwordInput").addEventListener("change", () => {
    loadWalletEncrypted();
  });

  document.getElementById("network").addEventListener("change", () => {
    const networkUrl = document.getElementById("network").value;
    initWeb3(networkUrl);
    fetchBalance();
  });

  // Initialize on load
  window.onload = () => {
    initWeb3(document.getElementById("network").value);
    loadWalletEncrypted();
  };
</script>
</body>
  </html>
